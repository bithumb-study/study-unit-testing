# [Unit Testing] 10장 데이터베이스 테스트

## 10.4 테스트 구절에서 코드 재사용하기

- 통합테스트가 너무 빨리 커지면 유지 보수 지표가 나빠질수있다
- 통합테스트는 가능한 짧게 하되 서로 결합하거나 가독성에 영향을 주면 안됨 아무리 짧은 테스트라도 서로 의존해서는 안된다.
- 통합 테스트 짧게 하기 좋은 방법은 기술적인 부분은 비공개 메서드나 헬퍼 메서드로 추출

### 10.4.1 준비 구절에서 코드 재사용하기

- 테스트 준비 구절 간에 코드를 재사용하기 가장 좋은 방법은 비공개 팩토리 메서드를 도입
#### 팩토리 메서드를 배치할 위치

- 기본적으로 팩토리 메서드를 동일한 클래스에 배치하라
- 코드 복제가 중요한 문제가 될 경우에만 별도의 헬퍼 클래스로 이동하라
- 기초 클래스에 팩토리 메서드를 넣지말아라
  - 데이터 정리와 같이 모든 테스트에서 실행해야 하는 코드를 위한 클래스로 남아야 한다.

### 10.4.2 실행 구절에서 코드 재사용하기

- 모든 통합테스트의 실행구절에서 데이터베이스 트랜잭션이나 작업 단위를 만든다.
- 실행구절 줄이는 방법
  - 어떤 컨트롤러 기능을 호출하는지에 대한 정보가 있는  대리자를 받는 메서드를 도입
  - 데코레이터(어노테이션 기반 AOP) 메서드를 사용하면 테스트 실행구절을 줄일수있다.

### 10.4.3 검증 구절에서 코드 재사용하기

- 검증 구절 줄이는 방법
  - 헬퍼 메서드를 만드는것이다.

### 10.4.4 테스트가 데이터베이스 트랜잭션을 너무 많이 생성하는가?

- 위에서 말한대로 실행하면 더 읽기 쉽고 유지 보수 가 용이 하지만 트랜잭션수가 많아질수 있다.
- 할수 있는것은 많지 않다. 빠른 피드백과 유지보수성과의 절충이 필요하다.
- 유지 보수성을 위해 성능을 양보함으로써 절충 하는것이 좋다.

## 10.5 데이터베이스 테스트에 대한 일반적인 질문

--

### 10.5.1 읽기 테스트를 해야 하는것인가?

- 읽기(read) 보다 쓰기(write) 테스트에 집중
- 읽기 작업의 버그는 보통 해로운 문제가 없고 복잡하거나 중요한 읽기 작업만 테스트 해라
- 쓰기작업은 철저히 테스트 해야한다.
  - 위험성이 높다.
  - 데이터가 손상돼 데이터베이스 뿐 아니라 외부 애플리케이션에도 영향이 있다.
  - 실수에 대비한 보호책이 되므로 매우 가치있음

### 10.5.2 리포지터리 테스트를 해야 하는가?

- 리포지터리 테스트는 유지비가 높고 회귀 방지가 떨어져 테스트 스위트에 손실이 된다.
#### 높은 유지비
- 복잡도가 거의 없고 프로세스 외부 의존성인 데이터베이스와 통신 하므로 유지비가 증가한다.
#### 낮은 회귀 방지
- 리포지터리는 그렇게 복잡하지 않으며 회귀방지가 떨어진다.
- 리포지터리가 갖고 있는 약간의 복잡도를 별도의 알고리즘으로 추출하고 해당 알고리즘 전용테스트를 작성하는것이 좋은 방법이다.
- 직접 테스트하지 말고 테스트 스위트의 일부로 취급하라.

## 10.6 결론

- 데이터베이스 테스트를 잘 만들면 버그로부터 훌륭히 보호할 수 있다.